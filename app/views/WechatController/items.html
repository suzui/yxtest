<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="yes" name="apple-touch-fullscreen">
    <title>${type}</title>
    <meta name="format-detection" content="telephone=no,email=no,adress=no" >
    <link rel="stylesheet" href="/public/stylesheets/items.css">
</head>
<body class="bg navbar-fix">
	<br/>
    <div class="content">
        <ul class="school-news">
        	#{list items:items,as:"item"}
            <li class="clear">
                <a href="@{WechatController.item(item.id)}">
                    <span class="news-left">
                        <img src="${item.cover}">
                    </span>
                    <span class="news-right clear">
                        <h1>${item.title}</h1>
                        <span class="news-comments">浏览 ${item.view()}</span> 
                        <span class="news-time">${item.createTime()}</span>
                    </span>
                </a>
            </li>
            #{/list}
        </ul>
    </div>

    <div class="bottom-effect" style="transform: matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, -0.0075, 0, 0, 0, 1);">
        <p style="width:100%" class="end-notice">上滑加载更多</p>
    </div>

    <script src="/public/javascripts/jquery.min.js"></script>
    <script src="/public/javascripts/flexible.js"></script>
    <script src="/public/javascripts/transform.js"></script>
    <script src="/public/javascripts/swiper.min.js"></script>
    <script>
    $(document).ready( function() {
        // banner
        if($('.swiper-container')[0]) {
            var swiper = new Swiper('.swiper-container', {
                pagination: '.swiper-pagination',
                paginationClickable: true,
                autoplay: 2500,
                autoplayDisableOnInteraction: false,
                loop:true
            });
        }

        var $content = $(".content"),
            target = $content[0];
        var $boteffect = $('.bottom-effect'),
            boteffect = $('.bottom-effect')[0];

        Transform(target);
        Transform(boteffect);

        /*
        * touch 
        */
        var bottomTop = $content.height() - $(window).height();
        var startY,lastY, 
            sliderHeight = $('.ui-slider').height(),
            isScale = false,
            isTouchStart = false,
            direction;

        $('body').on('touchstart', function (e) {
            e = event;
            if($(window).scrollTop()<= 0){
                direction = 'up'
            } else if($(window).scrollTop()>= (bottomTop-10)) {
                direction = 'down';
            } else {
                direction = null
            }
            if(direction){
                isTouchStart = true;
                isScale = true;
                startY = e.changedTouches[0].pageY;
                startX = e.changedTouches[0].pageX;
            }
        });

        $('body').on('touchmove',function (e) {
            e = event;
            if ( isTouchStart ){
                var dDis=Math.abs(e.touches[0].pageX - startX) - Math.abs(e.touches[0].pageY - startY);
                if(dDis>0) return;
                if(e.changedTouches[0].pageY - startY < 0 && isScale && direction=='down' && $(document).scrollTop() + $(window).height() >= $(document).height()){
                    // 上滑
                    e.preventDefault();
                    var currentY = -(startY-e.changedTouches[0].pageY)/2
                    if (currentY<-120){
                        currentY = -120
                    }
                    target.translateY = boteffect.translateY = currentY;
                }
                lastY =  e.changedTouches[0].pageY;
            }
        });
        $('body').on('touchend',function (e) {
            e = event;
            if(isTouchStart && isScale && $(document).scrollTop() + $(window).height() >= $(document).height()){     
                to(target, 'translateY', 0, 200, iosEase, function(){
                    console.log(startY, lastY);
                    // 动画结束回调

                    if(Math.abs(lastY - startY) > 120){
                        var schoolNews = $('.school-news');
                        for(var i=0; i<10; i++){
                            var cont =  '<li class="clear">'+
                                        '    <a href="javascript:;">'+
                                        '        <div class="news-left">'+
                                        '            <img src="img/news.jpg">'+
                                        '        </div>'+
                                        '        <div class="news-right clear">'+
                                        '            <h1>第三届全国智慧教育高层论坛将举办，神秘面纱抢先揭第三届全国智慧教育高层论坛将举办，神秘面纱抢先揭</h1>'+
                                        '            <span class="news-comments"><i class="iconfont icon-duihua"></i>32</span> '+
                                        '            <span class="news-time">1小时前</span>'+
                                        '        </div>'+
                                        '    </a>'+
                                        '</li>';
                            schoolNews.append(cont);
                        }
                    }
                });
                to(boteffect, 'translateY', 0, 200, iosEase);
                isScale = false;
            }
        });
        
        function iosEase(x) {
            return Math.sqrt(1 - Math.pow(x - 1, 2));
        }
        
        var tickID = 0
        function to(el, property, value, time, ease, onEnd) {
            var current = el[property];
            var dv = value - current;
            var beginTime = new Date();
            var toTick = function () {

                var dt = new Date() - beginTime;
                if (dt >= time) {
                    el[property] = value;
                    onEnd && onEnd(value);
                    return;
                }
                el[property] = dv * ease(dt / time) + current;
                tickID = requestAnimationFrame(toTick);
                //cancelAnimationFrame必须在 tickID = requestAnimationFrame(toTick);的后面
            }
            toTick();
        };

    });
    </script>
</body>
</html>